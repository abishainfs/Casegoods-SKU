<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Casegoods: SKU Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js" charset="utf-8"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F5F5F7;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 2rem;
        }
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .bg-apple-primary { background-color: #1C1C1E; }
        .hover\:bg-apple-primary-dark:hover { background-color: #3A3A3C; }
        .focus\:ring-apple-blue:focus { --tw-ring-color: #007AFF; }

        .text-apple-dark { color: #1D1D1F; }
        .text-apple-medium { color: #3C3C43; }
        .bg-apple-light { background-color: #FFFFFF; }
        .bg-apple-section { background-color: #F9F9FB; }
        .border-apple-light-border { border-color: #E5E5EA; }
        .text-apple-accent { color: #007AFF; }

        .main-container {
            display: flex;
            flex-direction: column;
            gap: 2rem;
            width: 100%;
            max-width: 1600px;
        }

        @media (min-width: 1024px) {
            .main-container {
                flex-direction: row;
                align-items: flex-start;
            }
            .main-form-card {
                flex: 2; /* Generator takes 2/3 of the space */
            }
            .sidebar-container {
                flex: 1; /* Sidebar takes 1/3 of the space */
                display: flex;
                flex-direction: column;
                gap: 2rem;
            }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div class="main-container">
        <!-- Main SKU Generation Form -->
        <div class="main-form-card bg-apple-light p-8 rounded-xl shadow-lg w-full border border-apple-light-border">
            <img src="https://placehold.co/150x50/1C1C1E/FFFFFF?text=CASEGOODS+LOGO" 
                 alt="Casegoods Logo" 
                 class="mx-auto mb-6 rounded-lg shadow-sm"
                 onerror="this.onerror=null;this.src='https://placehold.co/150x50/CCCCCC/666666?text=LOGO+NOT+FOUND';"
            >
            <h1 class="text-3xl font-extrabold text-apple-dark mb-6 text-center">Casegoods: SKU Generator</h1>

            <!-- Instructions Dropdown -->
            <details class="mb-6 p-4 bg-apple-section border border-apple-light-border rounded-lg">
                <summary class="text-lg font-semibold text-apple-dark cursor-pointer">How SKUs Work & How to Use This Tool</summary>
                <div class="mt-4 text-apple-medium text-sm leading-relaxed">
                    <p class="mb-2">Welcome to the Casegoods SKU Generator! This tool helps us create unique codes for all our products, making it easier to organize and track everything. Think of an SKU (Stock Keeping Unit) as a product's unique fingerprint.</p>
                    <p class="mb-4">Our SKUs follow a specific pattern: <strong class="text-apple-dark">X-ABCD-EF-GH-IJ</strong></p>
                    
                    <h4 class="font-bold text-apple-dark mb-2">The SKU Breakdown:</h4>
                    <ul class="list-disc list-inside mb-3">
                        <li class="mb-1"><strong class="text-apple-dark">X - Product Category (1 Letter):</strong> This first letter tells us what type of product it is.
                            <ul class="list-circle list-inside ml-4 mt-1">
                                <li><strong>F</strong> for Furniture</li>
                                <li><strong>L</strong> for Lights</li>
                                <li><strong>O</strong> for Objects</li>
                                <li><strong>H</strong> for Hardware</li>
                            </ul>
                        </li>
                        <li class="mb-1"><strong class="text-apple-dark">ABCD - Custom Code (Up to 4 Letters):</strong> This is a unique code for each specific product design. It's usually 3 letters, but can be up to 4. For example:
                            <ul class="list-circle list-inside ml-4 mt-1">
                                <li><strong>BND</strong> for Buenos Diyas</li>
                                <li><strong>FFC</strong> for Folding Flat Chair</li>
                            </ul>
                            <p class="text-xs text-gray-500 mt-1">If you enter fewer than 4 letters, the system will automatically add spaces to fill it out (e.g., "BND" becomes "BND ").</p>
                        </li>
                        <li class="mb-1"><strong class="text-apple-dark">EF - Size/Type (2 Digits):</strong> This is a two-digit number, starting from `01`, `02`, `03`, and so on. It represents standard product configurations or sizes. For instance, `01` might be the smallest size, `02` the next, and so on.</li>
                        <li class="mb-1"><strong class="text-apple-dark">GH - Customisable Material 1 (Optional: 1 Letter + 1 Digit):</strong> This part describes the <strong class="text-apple-dark">first main material</strong> used in the product and its finish.
                            <ul class="list-circle list-inside ml-4 mt-1">
                                <li>The <strong class="text-apple-dark">first letter (G)</strong> tells us the material type (e.g., <strong>T</strong> for Teakwood, <strong>A</strong> for Ash).</li>
                                <li>The <strong class="text-apple-dark">second digit (H)</strong> tells us how that material is finished (e.g., <strong>0</strong> for Unfinished, <strong>1</strong> for Oiled/Sealed).</li>
                            </ul>
                            <p class="text-xs text-gray-500 mt-1">This section is optional. If a product doesn't have a first customisable material, you can leave both "Material Type (G)" and "Material Finish (H)" blank in the generator.</p>
                        </li>
                        <li class="mb-1"><strong class="text-apple-dark">IJ - Customisable Material 2 (Optional: 1 Letter + 1 Digit):</strong> This works exactly like `GH`, but it's for the <strong class="text-apple-dark">second customisable material</strong> (if there is one).
                            <ul class="list-circle list-inside ml-4 mt-1">
                                <li>The <strong class="text-apple-dark">first letter (I)</strong> is the material type.</li>
                                <li>The <strong class="text-apple-dark">second digit (J)</strong> is its finish.</li>
                            </ul>
                            <p class="text-xs text-gray-500 mt-1">This section is also optional. If a product only has one customisable material, or none, you can leave this section blank.</p>
                        </li>
                    </ul>

                    <h4 class="font-bold text-apple-dark mb-2">How to Use the SKU Generator:</h4>
                    <ol class="list-decimal list-inside mb-3">
                        <li class="mb-1"><strong class="text-apple-dark">Fill in the Blanks:</strong>
                            <ul class="list-circle list-inside ml-4 mt-1">
                                <li><strong>Product Category (X):</strong> Choose the correct category from the dropdown.</li>
                                <li><strong>Custom Code (ABCD):</strong> Type in the unique code for the product design.</li>
                                <li><strong>Size/Type (EF):</strong> Enter the 2-digit number for the size or configuration.</li>
                                <li><strong>Customisable Material 1 (GH) & 2 (IJ):</strong> If your product has these materials, select both the <strong>Material Type</strong> and <strong>Material Finish</strong> from the dropdowns. If a product doesn't have a material for this section, simply leave both dropdowns blank.</li>
                            </ul>
                        </li>
                        <li class="mb-1"><strong class="text-apple-dark">Generate SKU:</strong> Click the <strong>"Generate SKU"</strong> button. The complete SKU will appear below.</li>
                        <li class="mb-1"><strong class="text-apple-dark">Copy SKU:</strong> Click the <strong>copy icon</strong> next to the generated SKU to quickly copy it to your clipboard. You can then paste it into our Google Sheet or Excel file.</li>
                    </ol>

                    <h4 class="font-bold text-apple-dark mb-2">Important Notes:</h4>
                    <ul class="list-disc list-inside mb-3">
                        <li class="mb-1"><strong>Material & Finish Legend:</strong> To the side, you'll find a <strong>"Material & Finish Legend"</strong> table. This is your go-to guide for all the material and finish codes. It's always up-to-date!</li>
                        <li class="mb-1"><strong>Logged SKUs:</strong> Also to the side, there's a <strong>"Logged SKUs"</strong> section. This shows all the unique SKUs that have been generated and saved by anyone using this tool.</li>
                        <li class="mb-1"><strong>No Duplicates!</strong> The system will check if an SKU you're trying to generate already exists in our records. If it does, you'll get an alert, and you'll need to adjust your inputs to create a unique SKU. This helps us keep our inventory clean and accurate.</li>
                    </ul>

                    <p class="font-bold text-apple-dark mt-4">Questions? If you have any doubts about how to use this tool or what codes to use, please don't hesitate to <strong class="text-apple-accent">ask the design team</strong>. They are here to help!</p>
                </div>
            </details>

            <!-- Product Category (X) -->
            <div class="mb-4">
                <label for="productCategory" class="block text-sm font-medium text-apple-medium mb-1">Product Category (X)</label>
                <select id="productCategory" class="w-full p-3 border border-apple-light-border rounded-lg focus:ring-apple-blue focus:border-apple-blue transition duration-150 ease-in-out">
                    <option value="" disabled selected>Select Category</option>
                    <option value="F">F - Furniture</option>
                    <option value="L">L - Lights</option>
                    <option value="O">O - Objects</option>
                    <option value="H">H - Hardware</option>
                </select>
            </div>

            <!-- Custom Input (ABCD) -->
            <div class="mb-4">
                <label for="customCode" class="block text-sm font-medium text-apple-medium mb-1">Custom Code (ABCD - Max 4 letters)</label>
                <input type="text" id="customCode" placeholder="e.g., BND, FFC (ask design team if unsure)" maxlength="4" class="w-full p-3 border border-apple-light-border rounded-lg focus:ring-apple-blue focus:border-apple-blue transition duration-150 ease-in-out">
            </div>

            <!-- Size/Type (EF) -->
            <div class="mb-6">
                <label for="sizeType" class="block text-sm font-medium text-apple-medium mb-1">Size/Type (EF - 2-digit number)</label>
                <input type="number" id="sizeType" placeholder="e.g., 01, 02" min="1" max="99" class="w-full p-3 border border-apple-light-border rounded-lg focus:ring-apple-blue focus:border-apple-blue transition duration-150 ease-in-out">
            </div>

            <!-- Customisable Material 1 (GH) -->
            <div class="mb-4 p-4 border border-apple-light-border rounded-lg bg-apple-section">
                <h3 class="text-md font-semibold text-apple-dark mb-3">Customisable Material 1 (GH) <span class="text-gray-500 text-sm">(Optional)</span></h3>
                <div class="flex flex-col sm:flex-row gap-4">
                    <div class="flex-1">
                        <label for="material1Type" class="block text-sm font-medium text-apple-medium mb-1">Material Type (G)</label>
                        <select id="material1Type" class="w-full p-3 border border-apple-light-border rounded-lg focus:ring-apple-blue focus:border-apple-blue transition duration-150 ease-in-out">
                            <option value="" selected>Select Type</option>
                        </select>
                    </div>
                    <div class="flex-1">
                        <label for="material1Finish" class="block text-sm font-medium text-apple-medium mb-1">Material Finish (H) <span class="text-xs text-gray-500">(Select Type First)</span></label>
                        <select id="material1Finish" class="w-full p-3 border border-apple-light-border rounded-lg focus:ring-apple-blue focus:border-apple-blue transition duration-150 ease-in-out">
                            <option value="" selected>Select Finish</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Customisable Material 2 (IJ) -->
            <div class="mb-6 p-4 border border-apple-light-border rounded-lg bg-apple-section">
                <h3 class="text-md font-semibold text-apple-dark mb-3">Customisable Material 2 (IJ) <span class="text-gray-500 text-sm">(Optional)</span></h3>
                <div class="flex flex-col sm:flex-row gap-4">
                    <div class="flex-1">
                        <label for="material2Type" class="block text-sm font-medium text-apple-medium mb-1">Material Type (I)</label>
                        <select id="material2Type" class="w-full p-3 border border-apple-light-border rounded-lg focus:ring-apple-blue focus:border-apple-blue transition duration-150 ease-in-out">
                            <option value="" selected>Select Type</option>
                        </select>
                    </div>
                    <div class="flex-1">
                        <label for="material2Finish" class="block text-sm font-medium text-apple-medium mb-1">Material Finish (J) <span class="text-xs text-gray-500">(Select Type First)</span></label>
                        <select id="material2Finish" class="w-full p-3 border border-apple-light-border rounded-lg focus:ring-apple-blue focus:border-apple-blue transition duration-150 ease-in-out">
                            <option value="" selected>Select Finish</option>
                        </select>
                    </div>
                </div>
            </div>

            <button id="generateSkuBtn" class="w-full bg-apple-primary text-white p-3 rounded-lg font-semibold hover:bg-apple-primary-dark focus:outline-none focus:ring-2 focus:ring-apple-blue focus:ring-offset-2 transition duration-150 ease-in-out shadow-md">
                Generate SKU
            </button>

            <div id="resultContainer" class="mt-8 p-4 bg-apple-section border border-apple-light-border rounded-lg text-center hidden">
                <h2 class="text-lg font-semibold text-apple-dark mb-2">Generated SKU:</h2>
                <div class="flex items-center justify-center space-x-2">
                    <p id="generatedSku" class="text-2xl font-bold text-apple-accent break-all"></p>
                    <button id="copySkuBtn" class="bg-gray-200 text-apple-medium p-2 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-apple-blue focus:ring-offset-2 transition duration-150 ease-in-out" title="Copy to clipboard">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h4.586a1 1 0 00.707-.293l3.414-3.414a1 1 0 00.293-.707V5a2 2 0 00-2-2h-2V5a2 2 0 01-2 2H6a2 2 0 01-2-2V3zM15 11l-3 3V9l3 2z" />
                        </svg>
                    </button>
                </div>
                <p id="copyMessage" class="text-sm text-green-600 mt-2 hidden">Copied to clipboard!</p>
            </div>
        </div>

        <!-- Sidebar Container for Legend and Logged SKUs -->
        <div class="sidebar-container">
            <!-- Material & Finish Legend -->
            <div class="legend-card bg-apple-light p-8 rounded-xl shadow-lg w-full border border-apple-light-border">
                <h2 class="text-2xl font-extrabold text-apple-dark mb-6 text-center">Material & Finish Legend</h2>
                <div id="materialLegend" class="overflow-x-auto">
                    <!-- Legend table will be dynamically inserted here -->
                </div>
            </div>

            <!-- Logged SKUs Section -->
            <div class="logged-skus-card bg-apple-light p-8 rounded-xl shadow-lg w-full border border-apple-light-border">
                <h2 class="text-2xl font-extrabold text-apple-dark mb-6 text-center">Logged SKUs</h2>
                <div id="loggedSkusList" class="p-4 bg-apple-section border border-apple-light-border rounded-lg max-h-96 overflow-y-auto">
                    <!-- Logged SKUs will be dynamically inserted here -->
                </div>
                <!-- New Download SKUs Button -->
                <button id="downloadSkusBtn" class="mt-4 w-full bg-apple-primary text-white p-3 rounded-lg font-semibold hover:bg-apple-primary-dark focus:outline-none focus:ring-2 focus:ring-apple-blue focus:ring-offset-2 transition duration-150 ease-in-out shadow-md">
                    Download SKUs
                </button>
            </div>
        </div>

        <!-- Custom Modal for Alerts -->
        <div id="customAlert" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-apple-light p-6 rounded-lg shadow-xl w-full max-w-sm text-center">
                <h3 class="text-lg font-semibold text-apple-dark mb-4">Input Required</h3>
                <p id="alertMessage" class="text-apple-medium mb-6"></p>
                <button id="alertCloseBtn" class="bg-apple-primary text-white p-2 rounded-lg font-semibold hover:bg-apple-primary-dark focus:outline-none focus:ring-2 focus:ring-apple-blue focus:ring-offset-2 transition duration-150 ease-in-out">
                    OK
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, addDoc, getDocs, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: For Vercel deployment, these values are hardcoded as they are not injected client-side
        // from Vercel's environment variables for static HTML files.
        const appId = 'casegoods-sku-generator'; // Your Firebase Project ID
        const firebaseConfig = {
          apiKey: "AIzaSyBi6frg0BYUKxPbhHD2AIuNsqcQtGGCTo0",
          authDomain: "casegoods-sku-generator.firebaseapp.com",
          projectId: "casegoods-sku-generator",
          storageBucket: "casegoods-sku-generator.firebasestorage.app",
          messagingSenderId: "875245303667",
          appId: "1:875245303667:web:cd48fbb62822247ce4f706",
          measurementId: "G-B0TLC9HCXJ"
        };

        let app;
        let db;
        let auth;
        let userId;

        // materialsData will be loaded from materials.json
        let materialsData = {}; 
        let currentLoggedSkus = []; // Store logged SKUs to easily access for download

        let productCategorySelect;
        let customCodeInput;
        let sizeTypeInput;
        let material1TypeSelect;
        let material1FinishSelect;
        let material2TypeSelect;
        let material2FinishSelect;
        let generateSkuBtn;
        let generatedSkuParagraph;
        let resultContainer;
        let copySkuBtn;
        let copyMessage;
        let customAlert;
        let alertMessage;
        let alertCloseBtn;
        let materialLegendDiv;
        let loggedSkusList;
        let downloadSkusBtn; // New button element

        function showAlert(message) {
            alertMessage.textContent = message;
            customAlert.classList.remove('hidden');
        }

        async function fetchMaterialsData() {
            try {
                // Changed the fetch path to be absolute from the root
                const response = await fetch('/materials.json');
                if (!response.ok) {
                    console.error(`HTTP error! Status: ${response.status}, Text: ${response.statusText}`);
                    throw new Error(`Failed to load materials.json. Status: ${response.status}`);
                }
                materialsData = await response.json();
                console.log("Materials data loaded successfully:", materialsData);
            } catch (error) {
                console.error("Error fetching materials.json:", error);
                showAlert(`Failed to load material data: ${error.message}. Please ensure 'materials.json' exists at the root of your deployment and is valid JSON.`);
                // Fallback to a minimal data set if loading fails
                materialsData = {
                    "T": { "name": "Teakwood (Fallback)", "finishes": { "0": "Unfinished" } },
                    "A": { "name": "Ash (Fallback)", "finishes": { "0": "Unfinished" } }
                };
            }
        }

        function populateMaterialTypes(selectElement) {
            const defaultOption = selectElement.querySelector('option[value=""][selected]');
            selectElement.innerHTML = ''; // Clear existing options
            if (defaultOption) {
                selectElement.appendChild(defaultOption.cloneNode(true));
            } else {
                const newDefaultOption = document.createElement('option');
                newDefaultOption.value = "";
                newDefaultOption.textContent = "Select Type";
                newDefaultOption.selected = true;
                selectElement.appendChild(newDefaultOption);
            }

            for (const code in materialsData) {
                const option = document.createElement('option');
                option.value = code;
                option.textContent = `${code} - ${materialsData[code].name}`;
                selectElement.appendChild(option);
            }
        }

        function populateMaterialFinishes(materialTypeSelect, finishSelectElement) {
            const selectedMaterialCode = materialTypeSelect.value;
            const defaultOption = finishSelectElement.querySelector('option[value=""][selected]');
            finishSelectElement.innerHTML = ''; // Clear existing options
            if (defaultOption) {
                finishSelectElement.appendChild(defaultOption.cloneNode(true));
            } else {
                const newDefaultOption = document.createElement('option');
                newDefaultOption.value = "";
                newDefaultOption.textContent = "Select Finish";
                newDefaultOption.selected = true;
                finishSelectElement.appendChild(newDefaultOption);
            }

            if (selectedMaterialCode && materialsData[selectedMaterialCode]) {
                const finishes = materialsData[selectedMaterialCode].finishes;
                for (const code in finishes) {
                    const option = document.createElement('option');
                    option.value = code;
                    option.textContent = `${code} - ${finishes[code]}`;
                    finishSelectElement.appendChild(option);
                }
            }
        }

        function generateMaterialLegend() {
            let legendHtml = '<table class="min-w-full bg-apple-light border border-apple-light-border rounded-lg shadow-sm">';
            legendHtml += '<thead>';
            legendHtml += '<tr class="bg-apple-section">';
            legendHtml += '<th class="py-2 px-4 border-b border-apple-light-border text-left text-sm font-medium text-apple-medium">Material Code</th>';
            legendHtml += '<th class="py-2 px-4 border-b border-apple-light-border text-left text-sm font-medium text-apple-medium">Material Name</th>';
            legendHtml += '<th class="py-2 px-4 border-b border-apple-light-border text-left text-sm font-medium text-apple-medium">Finish Code</th>';
            legendHtml += '<th class="py-2 px-4 border-b border-apple-light-border text-left text-sm font-medium text-apple-medium">Finish Name</th>';
            legendHtml += '</tr>';
            legendHtml += '</thead>';
            legendHtml += '<tbody>';

            for (const materialCode in materialsData) {
                const material = materialsData[materialCode];
                const finishes = material.finishes;
                const finishKeys = Object.keys(finishes);

                if (finishKeys.length === 0) {
                    legendHtml += `<tr>`;
                    legendHtml += `<td class="py-2 px-4 border-b border-apple-light-border text-sm text-apple-dark font-semibold">${materialCode}</td>`;
                    legendHtml += `<td class="py-2 px-4 border-b border-apple-light-border text-sm text-apple-dark">${material.name}</td>`;
                    legendHtml += `<td class="py-2 px-4 border-b border-apple-light-border text-sm text-apple-dark">N/A</td>`;
                    legendHtml += `<td class="py-2 px-4 border-b border-apple-light-border text-sm text-apple-dark">No Finishes</td>`;
                    legendHtml += `</tr>`;
                } else {
                    legendHtml += `<tr>`;
                    legendHtml += `<td class="py-2 px-4 border-b border-apple-light-border text-sm text-apple-dark font-semibold">${materialCode}</td>`;
                    legendHtml += `<td class="py-2 px-4 border-b border-apple-light-border text-sm text-apple-dark">${material.name}</td>`;
                    legendHtml += `<td class="py-2 px-4 border-b border-apple-light-border text-sm text-apple-dark">${finishKeys[0]}</td>`;
                    legendHtml += `<td class="py-2 px-4 border-b border-apple-light-border text-sm text-apple-dark">${finishes[finishKeys[0]]}</td>`;
                    legendHtml += `</tr>`;

                    for (let i = 1; i < finishKeys.length; i++) {
                        legendHtml += `<tr>`;
                        legendHtml += `<td class="py-2 px-4 border-b border-apple-light-border text-sm text-apple-dark"></td>`;
                        legendHtml += `<td class="py-2 px-4 border-b border-apple-light-border text-sm text-apple-dark"></td>`;
                        legendHtml += `<td class="py-2 px-4 border-b border-apple-light-border text-sm text-apple-dark">${finishKeys[i]}</td>`;
                        legendHtml += `<td class="py-2 px-4 border-b border-apple-light-border text-sm text-apple-dark">${finishes[finishKeys[i]]}</td>`;
                        legendHtml += `</tr>`;
                    }
                }
            }

            legendHtml += '</tbody>';
            legendHtml += '</table>';
            materialLegendDiv.innerHTML = legendHtml;
        }

        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                await signInAnonymously(auth);

                userId = auth.currentUser?.uid || crypto.randomUUID();
                console.log("Firebase initialized and authenticated. User ID:", userId);
                setupSkuListener();
            } catch (error) {
                console.error("Error initializing Firebase or authenticating:", error);
                showAlert("Failed to initialize database. Please try again later.");
            }
        }

        function setupSkuListener() {
            const skusCollectionRef = collection(db, `artifacts/${appId}/public/data/skus`);
            onSnapshot(skusCollectionRef, (snapshot) => {
                const skus = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.sku) {
                        skus.push(data.sku);
                    }
                });
                currentLoggedSkus = skus; // Update the array for download
                displayLoggedSkus(skus);
            }, (error) => {
                console.error("Error listening to SKUs:", error);
                showAlert("Failed to load logged SKUs.");
            });
        }

        function displayLoggedSkus(skus) {
            loggedSkusList.innerHTML = '';
            if (skus.length === 0) {
                loggedSkusList.innerHTML = '<p class="text-apple-medium text-center">No SKUs logged yet.</p>';
                return;
            }
            const ul = document.createElement('ul');
            ul.className = 'list-disc list-inside text-apple-medium space-y-1';
            skus.sort().forEach(sku => {
                const li = document.createElement('li');
                li.textContent = sku;
                ul.appendChild(li);
            });
            loggedSkusList.appendChild(ul);
        }

        // Function to download SKUs as a text file
        function downloadSkus() {
            if (currentLoggedSkus.length === 0) {
                showAlert("No SKUs to download.");
                return;
            }

            const skusText = currentLoggedSkus.join('\n');
            const blob = new Blob([skusText], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'logged_skus.txt';
            document.body.appendChild(a); // Append to body to make it clickable
            a.click(); // Programmatically click the link to trigger download
            document.body.removeChild(a); // Clean up the temporary link
            URL.revokeObjectURL(url); // Release the object URL
        }

        document.addEventListener('DOMContentLoaded', async () => {
            // Assign DOM elements once the window is loaded
            productCategorySelect = document.getElementById('productCategory');
            customCodeInput = document.getElementById('customCode');
            sizeTypeInput = document.getElementById('sizeType');
            material1TypeSelect = document.getElementById('material1Type');
            material1FinishSelect = document.getElementById('material1Finish');
            material2TypeSelect = document.getElementById('material2Type');
            material2FinishSelect = document.getElementById('material2Finish');
            generateSkuBtn = document.getElementById('generateSkuBtn');
            generatedSkuParagraph = document.getElementById('generatedSku');
            resultContainer = document.getElementById('resultContainer');
            copySkuBtn = document.getElementById('copySkuBtn');
            copyMessage = document.getElementById('copyMessage');
            customAlert = document.getElementById('customAlert');
            alertMessage = document.getElementById('alertMessage');
            alertCloseBtn = document.getElementById('alertCloseBtn');
            materialLegendDiv = document.getElementById('materialLegend');
            loggedSkusList = document.getElementById('loggedSkusList');
            downloadSkusBtn = document.getElementById('downloadSkusBtn'); // Get the new button

            // Fetch materials data before populating dropdowns and legend
            await fetchMaterialsData();

            alertCloseBtn.addEventListener('click', () => {
                customAlert.classList.add('hidden');
            });

            generateSkuBtn.addEventListener('click', async () => {
                const productCategory = productCategorySelect.value;
                const customCode = customCodeInput.value.trim().toUpperCase().padEnd(4, ' ').substring(0, 4);
                const sizeType = sizeTypeInput.value.trim();
                const material1Type = material1TypeSelect.value;
                const material1Finish = material1FinishSelect.value;
                const material2Type = material2TypeSelect.value;
                const material2Finish = material2FinishSelect.value;

                if (!productCategory || !customCode.trim() || !sizeType) {
                    showAlert('Please fill in Product Category, Custom Code, and Size/Type.');
                    return;
                }

                const formattedSizeType = String(sizeType).padStart(2, '0');

                let material1 = '';
                if (material1Type && material1Finish) {
                    material1 = material1Type + material1Finish;
                } else if (material1Type || material1Finish) {
                    showAlert('For Material 1, please select both a Type and a Finish, or leave both blank.');
                    return;
                }

                let material2 = '';
                if (material2Type && material2Finish) {
                    material2 = material2Type + material2Finish;
                } else if (material2Type || material2Finish) {
                    showAlert('For Material 2, please select both a Type and a Finish, or leave both blank.');
                    return;
                }

                let sku = `${productCategory}-${customCode}-${formattedSizeType}`;
                if (material1) {
                    sku += `-${material1}`;
                }
                if (material2) {
                    sku += `-${material2}`;
                }

                // Display the SKU in the current generator result area immediately
                generatedSkuParagraph.textContent = sku;
                resultContainer.classList.remove('hidden');
                copyMessage.classList.add('hidden');

                // Database operations for SKU logging (only if unique)
                if (!db || !auth.currentUser) {
                    showAlert("Database not ready or user not authenticated. Please try again.");
                    return;
                }

                const skusCollectionRef = collection(db, `artifacts/${appId}/public/data/skus`);
                try {
                    const q = query(skusCollectionRef, where("sku", "==", sku));
                    const querySnapshot = await getDocs(q);

                    if (!querySnapshot.empty) {
                        showAlert(`SKU "${sku}" already exists in the database. It will not be logged again.`);
                        // Do NOT addDoc if it's a duplicate
                    } else {
                        await addDoc(skusCollectionRef, {
                            sku: sku,
                            timestamp: serverTimestamp(),
                            generatedBy: userId
                        });
                        console.log("SKU added successfully:", sku);
                        // The onSnapshot listener will automatically update the list
                    }
                } catch (e) {
                    console.error("Error checking or adding SKU to database: ", e);
                    showAlert("Failed to interact with database. Please try again.");
                }
            });

            copySkuBtn.addEventListener('click', () => {
                const skuToCopy = generatedSkuParagraph.textContent;
                if (skuToCopy) {
                    const tempInput = document.createElement('textarea');
                    tempInput.value = skuToCopy;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    try {
                        document.execCommand('copy');
                        copyMessage.classList.remove('hidden');
                        setTimeout(() => {
                            copyMessage.classList.add('hidden');
                        }, 2000);
                    } catch (err) {
                        console.error('Failed to copy SKU: ', err);
                        showAlert('Failed to copy SKU. Please copy it manually.');
                    } finally {
                        document.body.removeChild(tempInput);
                    }
                } else {
                    showAlert('No SKU to copy. Please generate one first.');
                }
            });

            // Attach event listener for the new download button
            downloadSkusBtn.addEventListener('click', downloadSkus);

            // Populate dropdowns and legend after materialsData is fetched
            // Only populate if materialsData was successfully loaded and is not empty
            if (Object.keys(materialsData).length > 0) {
                populateMaterialTypes(material1TypeSelect);
                populateMaterialTypes(material2TypeSelect);
                // Initial population of finishes based on default selected type (which is empty)
                populateMaterialFinishes(material1TypeSelect, material1FinishSelect);
                populateMaterialFinishes(material2TypeSelect, material2FinishSelect);

                material1TypeSelect.addEventListener('change', () => {
                    populateMaterialFinishes(material1TypeSelect, material1FinishSelect);
                });
                material2TypeSelect.addEventListener('change', () => {
                    populateMaterialFinishes(material2TypeSelect, material2FinishSelect);
                });

                generateMaterialLegend();
            } else {
                // This block will be hit if fetchMaterialsData failed and set a fallback or empty object
                showAlert("Material data could not be loaded. Material selection and legend may not function correctly. Please ensure 'materials.json' exists at the root of your deployment and is valid JSON.");
            }
            
            initializeFirebase();
        });
    </script>
</body>
</html>
